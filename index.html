<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Community Learning Portal</title>
    <style>
        :root {
            --primary: #4361ee;
            --secondary: #3a0ca3;
            --success: #4cc9f0;
            --warning: #f72585;
            --light: #f8f9fa;
            --dark: #212529;
            --gray: #6c757d;
            --light-gray: #e9ecef;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f7fb;
            color: var(--dark);
            line-height: 1.6;
        }
        
        .container {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 15px;
        }
        
        header {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 1rem 0;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            font-size: 1.5rem;
            font-weight: bold;
        }
        
        .nav-links {
            display: flex;
            list-style: none;
        }
        
        .nav-links li {
            margin-left: 1.5rem;
        }
        
        .nav-links a {
            color: white;
            text-decoration: none;
            transition: opacity 0.3s;
        }
        
        .nav-links a:hover {
            opacity: 0.8;
        }
        
        .btn {
            display: inline-block;
            padding: 0.5rem 1rem;
            background-color: var(--primary);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            text-decoration: none;
            transition: background-color 0.3s;
        }
        
        .btn:hover {
            background-color: var(--secondary);
        }
        
        .btn-success {
            background-color: var(--success);
        }
        
        .btn-warning {
            background-color: var(--warning);
        }
        
        .main-content {
            padding: 2rem 0;
        }
        
        .page {
            display: none;
        }
        
        .active {
            display: block;
        }
        
        .card {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        
        .card-title {
            font-size: 1.25rem;
            margin-bottom: 1rem;
            color: var(--primary);
        }
        
        .subject-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 1.5rem;
        }
        
        .subject-card {
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s;
        }
        
        .subject-card:hover {
            transform: translateY(-5px);
        }
        
        .subject-card img {
            width: 100%;
            height: 150px;
            object-fit: cover;
        }
        
        .subject-card-content {
            padding: 1rem;
        }
        
        .subject-card h3 {
            margin-bottom: 0.5rem;
            color: var(--primary);
        }
        
        .material-list {
            list-style: none;
        }
        
        .material-item {
            padding: 1rem;
            border-bottom: 1px solid var(--light-gray);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .material-item:last-child {
            border-bottom: none;
        }
        
        .badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            background-color: var(--light-gray);
            color: var(--dark);
            border-radius: 20px;
            font-size: 0.75rem;
            margin-left: 0.5rem;
        }
        
        .badge-primary {
            background-color: var(--primary);
            color: white;
        }
        
        .badge-success {
            background-color: var(--success);
            color: white;
        }
        
        .badge-warning {
            background-color: var(--warning);
            color: white;
        }
        
        .quiz-container {
            margin-top: 1.5rem;
        }
        
        .quiz-question {
            margin-bottom: 1.5rem;
        }
        
        .quiz-options {
            list-style: none;
        }
        
        .quiz-options li {
            margin-bottom: 0.5rem;
        }
        
        .leaderboard {
            width: 100%;
            border-collapse: collapse;
        }
        
        .leaderboard th, .leaderboard td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid var(--light-gray);
        }
        
        .leaderboard th {
            background-color: var(--light-gray);
            font-weight: bold;
        }
        
        .leaderboard tr:hover {
            background-color: var(--light);
        }
        
        .form-group {
            margin-bottom: 1rem;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: bold;
        }
        
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid var(--light-gray);
            border-radius: 4px;
        }
        
        .ai-assistant {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            background-color: var(--primary);
            color: white;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            z-index: 1000;
        }
        
        .ai-chatbox {
            position: fixed;
            bottom: 90px;
            right: 20px;
            width: 300px;
            height: 400px;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            display: none;
            flex-direction: column;
            z-index: 1000;
        }
        
        .chat-header {
            padding: 1rem;
            background-color: var(--primary);
            color: white;
            border-top-left-radius: 10px;
            border-top-right-radius: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .chat-messages {
            flex: 1;
            padding: 1rem;
            overflow-y: auto;
        }
        
        .message {
            margin-bottom: 1rem;
            padding: 0.5rem;
            border-radius: 8px;
            max-width: 80%;
        }
        
        .ai-message {
            background-color: var(--light);
            align-self: flex-start;
        }
        
        .user-message {
            background-color: var(--primary);
            color: white;
            align-self: flex-end;
            margin-left: auto;
        }
        
        .chat-input {
            padding: 0.5rem;
            border-top: 1px solid var(--light-gray);
            display: flex;
        }
        
        .chat-input input {
            flex: 1;
            padding: 0.5rem;
            border: 1px solid var(--light-gray);
            border-radius: 20px;
            margin-right: 0.5rem;
        }
        
        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .stat-card {
            background: white;
            padding: 1rem;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            text-align: center;
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: var(--primary);
        }
        
        .stat-label {
            color: var(--gray);
            font-size: 0.9rem;
        }
        
        @media (max-width: 768px) {
            .subject-grid {
                grid-template-columns: 1fr;
            }
            
            .nav-links {
                display: none;
            }
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .error {
            color: red;
            margin-top: 0.5rem;
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <nav>
                <div class="logo">LearnHub</div>
                <ul class="nav-links">
                    <li><a href="#" onclick="showPage('dashboard')">Dashboard</a></li>
                    <li><a href="#" onclick="showPage('subjects')">Subjects</a></li>
                    <li><a href="#" onclick="showPage('materials')">Learning Materials</a></li>
                    <li><a href="#" onclick="showPage('quizzes')">Quizzes</a></li>
                    <li><a href="#" onclick="showPage('leaderboard')">Leaderboard</a></li>
                    <li id="teacher-menu" style="display:none;"><a href="#" onclick="showPage('teacher-dashboard')">Teacher Dashboard</a></li>
                    <li id="admin-menu" style="display:none;"><a href="#" onclick="showPage('admin-dashboard')">Admin Dashboard</a></li>
                </ul>
                <div>
                    <span id="user-info" style="color: white; margin-right: 1rem;"></span>
                    <a href="#" class="btn" onclick="logout()">Logout</a>
                </div>
            </nav>
        </div>
    </header>

    <div class="container main-content">
        <!-- Login Page -->
        <div id="login-page" class="page active">
            <div class="card">
                <h2 class="card-title">Login to Your Account</h2>
                <form id="login-form">
                    <div class="form-group">
                        <label for="login-email">Email</label>
                        <input type="email" id="login-email" required>
                    </div>
                    <div class="form-group">
                        <label for="login-password">Password</label>
                        <input type="password" id="login-password" required>
                    </div>
                    <button type="submit" class="btn">Login</button>
                    <div id="login-error" class="error"></div>
                </form>
                <p style="margin-top: 1rem;">Don't have an account? <a href="#" onclick="showPage('register-page')">Register here</a></p>
            </div>
        </div>

        <!-- Registration Page -->
        <div id="register-page" class="page">
            <div class="card">
                <h2 class="card-title">Create an Account</h2>
                <form id="register-form">
                    <div class="form-group">
                        <label for="register-name">Full Name</label>
                        <input type="text" id="register-name" required>
                    </div>
                    <div class="form-group">
                        <label for="register-email">Email</label>
                        <input type="email" id="register-email" required>
                    </div>
                    <div class="form-group">
                        <label for="register-password">Password</label>
                        <input type="password" id="register-password" required>
                    </div>
                    <div class="form-group">
                        <label for="register-role">I am a:</label>
                        <select id="register-role" required>
                            <option value="student">Student</option>
                            <option value="teacher">Teacher</option>
                            <option value="admin">Admin</option>
                        </select>
                    </div>
                    <button type="submit" class="btn">Register</button>
                    <div id="register-error" class="error"></div>
                </form>
                <p style="margin-top: 1rem;">Already have an account? <a href="#" onclick="showPage('login-page')">Login here</a></p>
            </div>
        </div>

        <!-- Student Dashboard -->
        <div id="dashboard" class="page">
            <h2>Welcome, <span id="user-name"></span>!</h2>
            <div class="stats-container">
                <div class="stat-card">
                    <div class="stat-value" id="total-points">0</div>
                    <div class="stat-label">Total Points</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="completed-quizzes">0</div>
                    <div class="stat-label">Quizzes Completed</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="badges-earned">0</div>
                    <div class="stat-label">Badges Earned</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="leaderboard-rank">-</div>
                    <div class="stat-label">Leaderboard Rank</div>
                </div>
            </div>

            <div class="card">
                <h3 class="card-title">Recommended Materials</h3>
                <ul class="material-list" id="recommended-materials">
                    <li>Loading materials...</li>
                </ul>
            </div>

            <div class="card">
                <h3 class="card-title">Recent Activity</h3>
                <div id="recent-activity">
                    <p>No recent activity yet.</p>
                </div>
            </div>
        </div>

        <!-- Subjects Page -->
        <div id="subjects" class="page">
            <h2>Subjects</h2>
            <div class="subject-grid" id="subject-list">
                <div>Loading subjects...</div>
            </div>
        </div>

        <!-- Materials Page -->
        <div id="materials" class="page">
            <h2>Learning Materials</h2>
            <div class="form-group">
                <input type="text" id="material-search" placeholder="Search materials...">
            </div>
            <div id="material-filters">
                <select id="subject-filter">
                    <option value="">All Subjects</option>
                </select>
                <select id="type-filter">
                    <option value="">All Types</option>
                    <option value="pdf">PDF</option>
                    <option value="video">Video</option>
                    <option value="note">Notes</option>
                </select>
            </div>
            <div id="materials-list">
                <div>Loading materials...</div>
            </div>
        </div>

        <!-- Quizzes Page -->
        <div id="quizzes" class="page">
            <h2>Available Quizzes</h2>
            <div id="quiz-list">
                <div>Loading quizzes...</div>
            </div>
        </div>

        <!-- Leaderboard Page -->
        <div id="leaderboard" class="page">
            <h2>Leaderboard</h2>
            <table class="leaderboard">
                <thead>
                    <tr>
                        <th>Rank</th>
                        <th>Name</th>
                        <th>Points</th>
                        <th>Badges</th>
                    </tr>
                </thead>
                <tbody id="leaderboard-body">
                    <tr><td colspan="4">Loading leaderboard...</td></tr>
                </tbody>
            </table>
        </div>

        <!-- Teacher Dashboard -->
        <div id="teacher-dashboard" class="page">
            <h2>Teacher Dashboard</h2>
            <div class="stats-container">
                <div class="stat-card">
                    <div class="stat-value" id="materials-uploaded">0</div>
                    <div class="stat-label">Materials Uploaded</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="students-reached">0</div>
                    <div class="stat-label">Students Reached</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="quizzes-created">0</div>
                    <div class="stat-label">Quizzes Created</div>
                </div>
            </div>

            <div class="card">
                <h3 class="card-title">Upload New Material</h3>
                <form id="upload-form">
                    <div class="form-group">
                        <label for="material-title">Title</label>
                        <input type="text" id="material-title" required>
                    </div>
                    <div class="form-group">
                        <label for="material-description">Description</label>
                        <textarea id="material-description" required></textarea>
                    </div>
                    <div class="form-group">
                        <label for="material-subject">Subject</label>
                        <select id="material-subject" required>
                            <option value="">Loading subjects...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="material-type">Type</label>
                        <select id="material-type" required>
                            <option value="pdf">PDF</option>
                            <option value="video">Video</option>
                            <option value="note">Notes</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="material-file">File (simulated)</label>
                        <input type="text" id="material-file" placeholder="File name" required>
                    </div>
                    <button type="submit" class="btn">Upload Material</button>
                    <div id="upload-error" class="error"></div>
                </form>
            </div>

            <div class="card">
                <h3 class="card-title">Create Quiz</h3>
                <form id="create-quiz-form">
                    <div class="form-group">
                        <label for="quiz-material">Select Material</label>
                        <select id="quiz-material" required>
                            <option value="">Loading materials...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="quiz-type">Quiz Type</label>
                        <select id="quiz-type" required>
                            <option value="manual">Create Manually</option>
                            <option value="ai">Generate with AI</option>
                        </select>
                    </div>
                    <div id="manual-quiz-creation" style="display: none;">
                        <div class="form-group">
                            <label>Question 1</label>
                            <input type="text" placeholder="Question" class="quiz-question-input">
                            <input type="text" placeholder="Option A" class="quiz-option-input">
                            <input type="text" placeholder="Option B" class="quiz-option-input">
                            <input type="text" placeholder="Option C" class="quiz-option-input">
                            <input type="text" placeholder="Option D" class="quiz-option-input">
                            <select class="quiz-correct-answer">
                                <option value="0">Correct Answer</option>
                                <option value="1">A</option>
                                <option value="2">B</option>
                                <option value="3">C</option>
                                <option value="4">D</option>
                            </select>
                        </div>
                        <button type="button" class="btn" onclick="addQuestion()">Add Another Question</button>
                    </div>
                    <button type="submit" class="btn">Create Quiz</button>
                    <div id="quiz-error" class="error"></div>
                </form>
            </div>
        </div>

        <!-- Admin Dashboard -->
        <div id="admin-dashboard" class="page">
            <h2>Admin Dashboard</h2>
            <div class="card">
                <h3 class="card-title">User Management</h3>
                <table class="leaderboard">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Role</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="user-management-body">
                        <tr><td colspan="5">Loading users...</td></tr>
                    </tbody>
                </table>
            </div>

            <div class="card">
                <h3 class="card-title">Content Moderation</h3>
                <table class="leaderboard">
                    <thead>
                        <tr>
                            <th>Title</th>
                            <th>Uploaded By</th>
                            <th>Subject</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="content-moderation-body">
                        <tr><td colspan="5">Loading materials for moderation...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- AI Assistant -->
    <div class="ai-assistant" onclick="toggleChat()">
        <span>AI</span>
    </div>

    <div class="ai-chatbox" id="ai-chat">
        <div class="chat-header">
            <h3>AI Learning Assistant</h3>
            <span onclick="toggleChat()" style="cursor: pointer;">X</span>
        </div>
        <div class="chat-messages" id="chat-messages">
            <div class="message ai-message">
                Hello! I'm your AI learning assistant. How can I help you today?
            </div>
        </div>
        <div class="chat-input">
            <input type="text" id="chat-input" placeholder="Ask a question...">
            <button class="btn" onclick="sendMessage()">Send</button>
        </div>
    </div>

    <script>
        // App State
        let currentUser = null;
        const API_BASE = 'api/'; // Base path for API endpoints

        // Initialize the application
        function initApp() {
            // Check if user is logged in
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                showAuthenticatedUI();
            } else {
                showPage('login-page');
            }
            
            // Set up event listeners
            document.getElementById('login-form').addEventListener('submit', handleLogin);
            document.getElementById('register-form').addEventListener('submit', handleRegister);
            document.getElementById('upload-form').addEventListener('submit', handleMaterialUpload);
            document.getElementById('create-quiz-form').addEventListener('submit', handleQuizCreation);
            document.getElementById('quiz-type').addEventListener('change', toggleQuizCreationMethod);
            document.getElementById('chat-input').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });
        }

        // API call function
        async function apiCall(endpoint, method = 'GET', data = null) {
            const options = {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                },
            };
            
            if (data && (method === 'POST' || method === 'PUT')) {
                options.body = JSON.stringify(data);
            }
            
            try {
                const response = await fetch(API_BASE + endpoint, options);
                const result = await response.json();
                
                if (!response.ok) {
                    throw new Error(result.message || 'API request failed');
                }
                
                return result;
            } catch (error) {
                console.error('API call error:', error);
                throw error;
            }
        }

        // Show the appropriate page
        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            document.getElementById(pageId).classList.add('active');
        }

        // Handle login form submission
        async function handleLogin(e) {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            const errorElement = document.getElementById('login-error');
            errorElement.textContent = '';
            
            const loginBtn = e.target.querySelector('button[type="submit"]');
            const originalText = loginBtn.textContent;
            loginBtn.innerHTML = '<span class="loading"></span> Logging in...';
            loginBtn.disabled = true;
            
            try {
                const result = await apiCall('auth.php', 'POST', {
                    action: 'login',
                    email: email,
                    password: password
                });
                
                if (result.success) {
                    currentUser = result.user;
                    localStorage.setItem('currentUser', JSON.stringify(result.user));
                    showAuthenticatedUI();
                    showPage('dashboard');
                } else {
                    errorElement.textContent = result.message;
                }
            } catch (error) {
                errorElement.textContent = error.message || 'Login failed. Please try again.';
            } finally {
                loginBtn.textContent = originalText;
                loginBtn.disabled = false;
            }
        }

        // Handle registration form submission
        async function handleRegister(e) {
            e.preventDefault();
            const name = document.getElementById('register-name').value;
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;
            const role = document.getElementById('register-role').value;
            const errorElement = document.getElementById('register-error');
            errorElement.textContent = '';
            
            const registerBtn = e.target.querySelector('button[type="submit"]');
            const originalText = registerBtn.textContent;
            registerBtn.innerHTML = '<span class="loading"></span> Registering...';
            registerBtn.disabled = true;
            
            try {
                const result = await apiCall('auth.php', 'POST', {
                    action: 'register',
                    name: name,
                    email: email,
                    password: password,
                    role: role
                });
                
                if (result.success) {
                    currentUser = result.user;
                    localStorage.setItem('currentUser', JSON.stringify(result.user));
                    showAuthenticatedUI();
                    showPage('dashboard');
                } else {
                    errorElement.textContent = result.message;
                }
            } catch (error) {
                errorElement.textContent = error.message || 'Registration failed. Please try again.';
            } finally {
                registerBtn.textContent = originalText;
                registerBtn.disabled = false;
            }
        }

        // Logout function
        async function logout() {
            try {
                await apiCall('auth.php', 'POST', { action: 'logout' });
            } catch (error) {
                console.error('Logout error:', error);
            } finally {
                currentUser = null;
                localStorage.removeItem('currentUser');
                showPage('login-page');
                document.getElementById('user-info').textContent = '';
                document.getElementById('teacher-menu').style.display = 'none';
                document.getElementById('admin-menu').style.display = 'none';
            }
        }

        // Show authenticated UI
        function showAuthenticatedUI() {
            document.getElementById('user-info').textContent = `Hello, ${currentUser.name}`;
            document.getElementById('user-name').textContent = currentUser.name;
            
            if (currentUser.role === 'teacher') {
                document.getElementById('teacher-dashboard').style.display = 'block';
                populateTeacherDashboard();
            } else {
                document.getElementById('teacher-dashboard').style.display = 'none';
            }
            
            if (currentUser.role === 'admin') {
                document.getElementById('admin-dashboard').style.display = 'block';
                populateAdminDashboard();
            } else {
                document.getElementById('admin-dashboard').style.display = 'none';
            }
            
            // Update student dashboard stats
            if (currentUser.role === 'student') {
                updateStudentStats();
                populateRecommendedMaterials();
            }
            
            // Populate various pages
            populateSubjects();
            populateMaterials();
            populateQuizzes();
            populateLeaderboard();
            
            showPage('dashboard');
        }

        // Update student dashboard statistics
        async function updateStudentStats() {
            document.getElementById('total-points').textContent = currentUser.points || 0;
            
            try {
                const results = await apiCall('results.php?user_id=' + currentUser.id);
                document.getElementById('completed-quizzes').textContent = results.length;
            } catch (error) {
                console.error('Error fetching results:', error);
            }
            
            document.getElementById('badges-earned').textContent = currentUser.badges ? currentUser.badges.length : 0;
            
            // Calculate leaderboard rank
            try {
                const users = await apiCall('users.php?role=student');
                users.sort((a, b) => (b.points || 0) - (a.points || 0));
                const rank = users.findIndex(u => u.id === currentUser.id) + 1;
                document.getElementById('leaderboard-rank').textContent = rank > 0 ? `#${rank}` : '-';
            } catch (error) {
                console.error('Error fetching leaderboard:', error);
            }
        }

        // Populate recommended materials
        async function populateRecommendedMaterials() {
            try {
                const materials = await apiCall('materials.php?status=approved&limit=3');
                const list = document.getElementById('recommended-materials');
                list.innerHTML = '';
                
                if (materials.length === 0) {
                    list.innerHTML = '<li>No materials available yet.</li>';
                    return;
                }
                
                materials.forEach(material => {
                    const li = document.createElement('li');
                    li.className = 'material-item';
                    li.innerHTML = `
                        <div>
                            <strong>${material.title}</strong>
                            <span class="badge">${material.subject_name}</span>
                            <span class="badge">${material.type.toUpperCase()}</span>
                        </div>
                        <a href="#" class="btn" onclick="downloadMaterial(${material.id})">Download</a>
                    `;
                    list.appendChild(li);
                });
            } catch (error) {
                console.error('Error fetching materials:', error);
                document.getElementById('recommended-materials').innerHTML = '<li>Error loading materials.</li>';
            }
        }

        // Populate subjects page
        async function populateSubjects() {
            try {
                const subjects = await apiCall('subjects.php');
                const grid = document.getElementById('subject-list');
                grid.innerHTML = '';
                
                if (subjects.length === 0) {
                    grid.innerHTML = '<div>No subjects available.</div>';
                    return;
                }
                
                for (const subject of subjects) {
                    const materials = await apiCall(`materials.php?subject_id=${subject.id}&status=approved`);
                    
                    const card = document.createElement('div');
                    card.className = 'subject-card';
                    card.innerHTML = `
                        <img src="${subject.image}" alt="${subject.name}">
                        <div class="subject-card-content">
                            <h3>${subject.name}</h3>
                            <p>${materials.length} learning materials</p>
                            <a href="#" class="btn" onclick="showSubjectMaterials(${subject.id})">Explore</a>
                        </div>
                    `;
                    grid.appendChild(card);
                }
            } catch (error) {
                console.error('Error fetching subjects:', error);
                document.getElementById('subject-list').innerHTML = '<div>Error loading subjects.</div>';
            }
        }

        // Populate materials page
        async function populateMaterials() {
            try {
                const materials = await apiCall('materials.php?status=approved');
                const container = document.getElementById('materials-list');
                container.innerHTML = '';
                
                // Populate subject filter
                const subjectFilter = document.getElementById('subject-filter');
                try {
                    const subjects = await apiCall('subjects.php');
                    subjects.forEach(subject => {
                        const option = document.createElement('option');
                        option.value = subject.id;
                        option.textContent = subject.name;
                        subjectFilter.appendChild(option);
                    });
                } catch (error) {
                    console.error('Error fetching subjects for filter:', error);
                }
                
                // Display materials
                if (materials.length === 0) {
                    container.innerHTML = '<p>No materials available yet.</p>';
                    return;
                }
                
                materials.forEach(material => {
                    const card = document.createElement('div');
                    card.className = 'card';
                    card.innerHTML = `
                        <h3>${material.title}</h3>
                        <p>${material.description}</p>
                        <div>
                            <span class="badge badge-primary">${material.subject_name}</span>
                            <span class="badge">${material.type.toUpperCase()}</span>
                            <span class="badge">Uploaded by: ${material.uploaded_by_name}</span>
                            <span class="badge">Downloads: ${material.downloads}</span>
                        </div>
                        <div style="margin-top: 1rem;">
                            <a href="#" class="btn" onclick="downloadMaterial(${material.id})">Download</a>
                            <a href="#" class="btn" onclick="takeQuiz(${material.id})">Take Quiz</a>
                        </div>
                    `;
                    container.appendChild(card);
                });
            } catch (error) {
                console.error('Error fetching materials:', error);
                document.getElementById('materials-list').innerHTML = '<p>Error loading materials.</p>';
            }
        }

        // Populate quizzes page
        async function populateQuizzes() {
            try {
                const quizzes = await apiCall('quizzes.php');
                const container = document.getElementById('quiz-list');
                container.innerHTML = '';
                
                if (quizzes.length === 0) {
                    container.innerHTML = '<p>No quizzes available yet.</p>';
                    return;
                }
                
                quizzes.forEach(quiz => {
                    const card = document.createElement('div');
                    card.className = 'card';
                    card.innerHTML = `
                        <h3>${quiz.title}</h3>
                        <p>Based on: ${quiz.material_title}</p>
                        <div>
                            <span class="badge badge-primary">${quiz.subject_name}</span>
                            <span class="badge">${quiz.questions.length} questions</span>
                        </div>
                        <div style="margin-top: 1rem;">
                            <a href="#" class="btn" onclick="startQuiz(${quiz.id})">Start Quiz</a>
                        </div>
                    `;
                    container.appendChild(card);
                });
            } catch (error) {
                console.error('Error fetching quizzes:', error);
                document.getElementById('quiz-list').innerHTML = '<p>Error loading quizzes.</p>';
            }
        }

        // Populate leaderboard
        async function populateLeaderboard() {
            try {
                const users = await apiCall('users.php?role=student');
                users.sort((a, b) => (b.points || 0) - (a.points || 0));
                
                const tbody = document.getElementById('leaderboard-body');
                tbody.innerHTML = '';
                
                users.forEach((user, index) => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${index + 1}</td>
                        <td>${user.name}</td>
                        <td>${user.points || 0}</td>
                        <td>${user.badges ? user.badges.join(', ') : ''}</td>
                    `;
                    tbody.appendChild(row);
                });
            } catch (error) {
                console.error('Error fetching leaderboard:', error);
                document.getElementById('leaderboard-body').innerHTML = '<tr><td colspan="4">Error loading leaderboard.</td></tr>';
            }
        }

        // Populate teacher dashboard
        async function populateTeacherDashboard() {
            if (currentUser.role !== 'teacher') return;
            
            try {
                // Update stats
                const materials = await apiCall(`materials.php?uploaded_by=${currentUser.id}`);
                document.getElementById('materials-uploaded').textContent = materials.length;
                
                let totalDownloads = 0;
                materials.forEach(m => {
                    totalDownloads += m.downloads || 0;
                });
                document.getElementById('students-reached').textContent = totalDownloads;
                
                const quizzes = await apiCall(`quizzes.php?teacher_id=${currentUser.id}`);
                document.getElementById('quizzes-created').textContent = quizzes.length;
                
                // Populate subject dropdown
                const subjectSelect = document.getElementById('material-subject');
                subjectSelect.innerHTML = '';
                const subjects = await apiCall('subjects.php');
                subjects.forEach(subject => {
                    const option = document.createElement('option');
                    option.value = subject.id;
                    option.textContent = subject.name;
                    subjectSelect.appendChild(option);
                });
                
                // Populate quiz material dropdown
                const quizMaterialSelect = document.getElementById('quiz-material');
                quizMaterialSelect.innerHTML = '';
                materials.forEach(material => {
                    const option = document.createElement('option');
                    option.value = material.id;
                    option.textContent = material.title;
                    quizMaterialSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Error populating teacher dashboard:', error);
            }
        }

        // Populate admin dashboard
        async function populateAdminDashboard() {
            if (currentUser.role !== 'admin') return;
            
            try {
                // User management
                const users = await apiCall('users.php');
                const userTbody = document.getElementById('user-management-body');
                userTbody.innerHTML = '';
                
                users.forEach(user => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${user.name}</td>
                        <td>${user.email}</td>
                        <td>${user.role}</td>
                        <td>Active</td>
                        <td>
                            <button class="btn" onclick="editUser(${user.id})">Edit</button>
                            <button class="btn btn-warning" onclick="suspendUser(${user.id})">Suspend</button>
                        </td>
                    `;
                    userTbody.appendChild(row);
                });
                
                // Content moderation
                const materials = await apiCall('materials.php');
                const contentTbody = document.getElementById('content-moderation-body');
                contentTbody.innerHTML = '';
                
                materials.forEach(material => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${material.title}</td>
                        <td>${material.uploaded_by_name}</td>
                        <td>${material.subject_name}</td>
                        <td>${material.status}</td>
                        <td>
                            ${material.status === 'pending' ? `
                                <button class="btn btn-success" onclick="approveMaterial(${material.id})">Approve</button>
                                <button class="btn btn-warning" onclick="rejectMaterial(${material.id})">Reject</button>
                            ` : `
                                <button class="btn btn-warning" onclick="removeMaterial(${material.id})">Remove</button>
                            `}
                        </td>
                    `;
                    contentTbody.appendChild(row);
                });
            } catch (error) {
                console.error('Error populating admin dashboard:', error);
            }
        }

        // Handle material upload
        async function handleMaterialUpload(e) {
            e.preventDefault();
            if (currentUser.role !== 'teacher') return;
            
            const title = document.getElementById('material-title').value;
            const description = document.getElementById('material-description').value;
            const subjectId = parseInt(document.getElementById('material-subject').value);
            const type = document.getElementById('material-type').value;
            const file = document.getElementById('material-file').value;
            const errorElement = document.getElementById('upload-error');
            errorElement.textContent = '';
            
            const uploadBtn = e.target.querySelector('button[type="submit"]');
            const originalText = uploadBtn.textContent;
            uploadBtn.innerHTML = '<span class="loading"></span> Uploading...';
            uploadBtn.disabled = true;
            
            try {
                const result = await apiCall('materials.php', 'POST', {
                    action: 'upload',
                    title: title,
                    description: description,
                    subject_id: subjectId,
                    type: type,
                    file: file,
                    uploaded_by: currentUser.id
                });
                
                if (result.success) {
                    alert('Material uploaded successfully! Waiting for admin approval.');
                    e.target.reset();
                    populateTeacherDashboard();
                } else {
                    errorElement.textContent = result.message;
                }
            } catch (error) {
                errorElement.textContent = error.message || 'Upload failed. Please try again.';
            } finally {
                uploadBtn.textContent = originalText;
                uploadBtn.disabled = false;
            }
        }

        // Handle quiz creation
        async function handleQuizCreation(e) {
            e.preventDefault();
            if (currentUser.role !== 'teacher') return;
            
            const materialId = parseInt(document.getElementById('quiz-material').value);
            const type = document.getElementById('quiz-type').value;
            const errorElement = document.getElementById('quiz-error');
            errorElement.textContent = '';
            
            const quizBtn = e.target.querySelector('button[type="submit"]');
            const originalText = quizBtn.textContent;
            quizBtn.innerHTML = '<span class="loading"></span> Creating...';
            quizBtn.disabled = true;
            
            try {
                if (type === 'ai') {
                    // Simulate AI quiz generation
                    const result = await apiCall('quizzes.php', 'POST', {
                        action: 'generate_ai_quiz',
                        material_id: materialId
                    });
                    
                    if (result.success) {
                        alert('Quiz generated successfully!');
                    } else {
                        errorElement.textContent = result.message;
                    }
                } else {
                    // Manual quiz creation
                    const questionInputs = document.querySelectorAll('.quiz-question-input');
                    const questions = [];
                    
                    questionInputs.forEach((input, index) => {
                        const question = input.value;
                        const options = [
                            document.querySelectorAll('.quiz-option-input')[index * 4].value,
                            document.querySelectorAll('.quiz-option-input')[index * 4 + 1].value,
                            document.querySelectorAll('.quiz-option-input')[index * 4 + 2].value,
                            document.querySelectorAll('.quiz-option-input')[index * 4 + 3].value
                        ];
                        const correctAnswer = parseInt(document.querySelectorAll('.quiz-correct-answer')[index].value);
                        
                        if (question && options.every(opt => opt) && !isNaN(correctAnswer)) {
                            questions.push({
                                question,
                                options,
                                correct_answer: correctAnswer
                            });
                        }
                    });
                    
                    if (questions.length === 0) {
                        errorElement.textContent = 'Please add at least one valid question';
                        return;
                    }
                    
                    const result = await apiCall('quizzes.php', 'POST', {
                        action: 'create_manual_quiz',
                        material_id: materialId,
                        questions: questions
                    });
                    
                    if (result.success) {
                        alert('Quiz created successfully!');
                    } else {
                        errorElement.textContent = result.message;
                    }
                }
            } catch (error) {
                errorElement.textContent = error.message || 'Quiz creation failed. Please try again.';
            } finally {
                quizBtn.textContent = originalText;
                quizBtn.disabled = false;
            }
        }

        // Toggle quiz creation method
        function toggleQuizCreationMethod() {
            const type = document.getElementById('quiz-type').value;
            const manualSection = document.getElementById('manual-quiz-creation');
            
            if (type === 'manual') {
                manualSection.style.display = 'block';
            } else {
                manualSection.style.display = 'none';
            }
        }

        // Add another question to manual quiz creation
        function addQuestion() {
            const manualSection = document.getElementById('manual-quiz-creation');
            const newQuestion = document.createElement('div');
            newQuestion.className = 'form-group';
            newQuestion.innerHTML = `
                <label>Question ${document.querySelectorAll('.quiz-question-input').length + 1}</label>
                <input type="text" placeholder="Question" class="quiz-question-input">
                <input type="text" placeholder="Option A" class="quiz-option-input">
                <input type="text" placeholder="Option B" class="quiz-option-input">
                <input type="text" placeholder="Option C" class="quiz-option-input">
                <input type="text" placeholder="Option D" class="quiz-option-input">
                <select class="quiz-correct-answer">
                    <option value="0">Correct Answer</option>
                    <option value="1">A</option>
                    <option value="2">B</option>
                    <option value="3">C</option>
                    <option value="4">D</option>
                </select>
            `;
            manualSection.insertBefore(newQuestion, manualSection.lastElementChild);
        }

        // Download material
        async function downloadMaterial(materialId) {
            try {
                const result = await apiCall('materials.php', 'POST', {
                    action: 'download',
                    material_id: materialId,
                    user_id: currentUser.id
                });
                
                if (result.success) {
                    alert(`Downloading: ${result.material.title}`);
                    
                    // Add to recent activity
                    if (currentUser.role === 'student') {
                        const activity = document.getElementById('recent-activity');
                        const p = document.createElement('p');
                        p.textContent = `Downloaded: ${result.material.title} - ${new Date().toLocaleString()}`;
                        activity.insertBefore(p, activity.firstChild);
                    }
                } else {
                    alert('Download failed: ' + result.message);
                }
            } catch (error) {
                alert('Download failed. Please try again.');
                console.error('Download error:', error);
            }
        }

        // Start a quiz
        async function startQuiz(quizId) {
            try {
                const quiz = await apiCall(`quizzes.php?id=${quizId}`);
                
                // Create quiz interface
                const container = document.getElementById('quiz-list');
                container.innerHTML = '';
                
                const quizCard = document.createElement('div');
                quizCard.className = 'card';
                quizCard.innerHTML = `<h3>${quiz.title}</h3>`;
                
                const quizForm = document.createElement('form');
                quizForm.id = 'quiz-taking-form';
                
                quiz.questions.forEach((q, index) => {
                    const questionDiv = document.createElement('div');
                    questionDiv.className = 'quiz-question';
                    questionDiv.innerHTML = `<p><strong>${index + 1}. ${q.question}</strong></p>`;
                    
                    const optionsList = document.createElement('ul');
                    optionsList.className = 'quiz-options';
                    
                    q.options.forEach((option, optIndex) => {
                        const li = document.createElement('li');
                        li.innerHTML = `
                            <input type="radio" name="question-${index}" id="q${index}-opt${optIndex}" value="${optIndex}">
                            <label for="q${index}-opt${optIndex}">${option}</label>
                        `;
                        optionsList.appendChild(li);
                    });
                    
                    questionDiv.appendChild(optionsList);
                    quizForm.appendChild(questionDiv);
                });
                
                const submitButton = document.createElement('button');
                submitButton.type = 'button';
                submitButton.className = 'btn';
                submitButton.textContent = 'Submit Quiz';
                submitButton.onclick = function() { calculateScore(quiz); };
                
                quizForm.appendChild(submitButton);
                quizCard.appendChild(quizForm);
                container.appendChild(quizCard);
            } catch (error) {
                console.error('Error loading quiz:', error);
                alert('Failed to load quiz. Please try again.');
            }
        }

        // Calculate quiz score
        async function calculateScore(quiz) {
            let score = 0;
            const results = [];
            
            quiz.questions.forEach((q, index) => {
                const selectedOption = document.querySelector(`input[name="question-${index}"]:checked`);
                const userAnswer = selectedOption ? parseInt(selectedOption.value) : -1;
                
                results.push({
                    question: q.question,
                    userAnswer,
                    correctAnswer: q.correctAnswer
                });
                
                if (userAnswer === q.correctAnswer) {
                    score++;
                }
            });
            
            // Save result
            if (currentUser.role === 'student') {
                try {
                    const result = await apiCall('results.php', 'POST', {
                        user_id: currentUser.id,
                        quiz_id: quiz.id,
                        score: score,
                        total: quiz.questions.length,
                        details: JSON.stringify(results)
                    });
                    
                    // Award points
                    const pointsEarned = score * 10;
                    currentUser.points = (currentUser.points || 0) + pointsEarned;
                    
                    // Update user in localStorage
                    localStorage.setItem('currentUser', JSON.stringify(currentUser));
                    
                    // Update user in database
                    await apiCall('users.php', 'PUT', {
                        id: currentUser.id,
                        points: currentUser.points
                    });
                    
                    // Award badge if this is the first perfect score
                    if (score === quiz.questions.length) {
                        const material = await apiCall(`materials.php?quiz_id=${quiz.id}`);
                        const subject = await apiCall(`subjects.php?id=${material.subject_id}`);
                        const badgeName = `${subject.name} Master`;
                        
                        if (!currentUser.badges) currentUser.badges = [];
                        if (!currentUser.badges.includes(badgeName)) {
                            currentUser.badges.push(badgeName);
                            
                            // Update user badges
                            await apiCall('users.php', 'PUT', {
                                id: currentUser.id,
                                badges: currentUser.badges.join(',')
                            });
                            
                            alert(`Congratulations! You earned the "${badgeName}" badge!`);
                        }
                    }
                    
                    // Show results
                    const container = document.getElementById('quiz-list');
                    container.innerHTML = '';
                    
                    const resultsCard = document.createElement('div');
                    resultsCard.className = 'card';
                    resultsCard.innerHTML = `
                        <h3>Quiz Results</h3>
                        <p>You scored ${score} out of ${quiz.questions.length}</p>
                        <p>Points earned: ${pointsEarned}</p>
                        <h4>Question Review:</h4>
                    `;
                    
                    results.forEach((r, index) => {
                        const isCorrect = r.userAnswer === r.correctAnswer;
                        resultsCard.innerHTML += `
                            <div class="quiz-question">
                                <p><strong>${index + 1}. ${r.question}</strong></p>
                                <p>Your answer: ${r.userAnswer >= 0 ? quiz.questions[index].options[r.userAnswer] : 'Not answered'} 
                                <span style="color: ${isCorrect ? 'green' : 'red'}">${isCorrect ? '' : ''}</span></p>
                                ${!isCorrect ? `<p>Correct answer: ${quiz.questions[index].options[r.correctAnswer]}</p>` : ''}
                            </div>
                        `;
                    });
                    
                    const backButton = document.createElement('button');
                    backButton.className = 'btn';
                    backButton.textContent = 'Back to Quizzes';
                    backButton.onclick = function() { populateQuizzes(); };
                    
                    resultsCard.appendChild(backButton);
                    container.appendChild(resultsCard);
                    
                    // Update stats
                    updateStudentStats();
                } catch (error) {
                    console.error('Error saving quiz result:', error);
                    alert('Error saving your quiz result. Please try again.');
                }
            }
        }

        // Take quiz for a specific material
        async function takeQuiz(materialId) {
            try {
                const quiz = await apiCall(`quizzes.php?material_id=${materialId}`);
                if (quiz) {
                    showPage('quizzes');
                    startQuiz(quiz.id);
                } else {
                    alert('No quiz available for this material yet.');
                }
            } catch (error) {
                console.error('Error fetching quiz:', error);
                alert('No quiz available for this material yet.');
            }
        }

        // Show materials for a specific subject
        function showSubjectMaterials(subjectId) {
            showPage('materials');
            document.getElementById('subject-filter').value = subjectId;
            // In a real app, we would filter the materials here
        }

        // Toggle AI chat
        function toggleChat() {
            const chat = document.getElementById('ai-chat');
            chat.style.display = chat.style.display === 'flex' ? 'none' : 'flex';
        }

        // Send message to AI assistant
        function sendMessage() {
            const input = document.getElementById('chat-input');
            const message = input.value.trim();
            
            if (message) {
                // Add user message
                const messagesContainer = document.getElementById('chat-messages');
                const userMessage = document.createElement('div');
                userMessage.className = 'message user-message';
                userMessage.textContent = message;
                messagesContainer.appendChild(userMessage);
                
                // Clear input
                input.value = '';
                
                // Simulate AI response
                setTimeout(() => {
                    const aiResponse = document.createElement('div');
                    aiResponse.className = 'message ai-message';
                    
                    // Simple response logic based on keywords
                    if (message.toLowerCase().includes('photo') || message.toLowerCase().includes('photosynthesis')) {
                        aiResponse.textContent = 'Photosynthesis is the process by which plants use sunlight, water, and carbon dioxide to create oxygen and energy in the form of sugar.';
                    } else if (message.toLowerCase().includes('algebra') || message.toLowerCase().includes('equation')) {
                        aiResponse.textContent = 'Algebra is a branch of mathematics dealing with symbols and the rules for manipulating those symbols. In elementary algebra, those symbols represent quantities without fixed values.';
                    } else if (message.toLowerCase().includes('cell') || message.toLowerCase().includes('biology')) {
                        aiResponse.textContent = 'Cells are the basic building blocks of all living things. The human body is composed of trillions of cells. They provide structure for the body, take in nutrients from food, convert those nutrients into energy, and carry out specialized functions.';
                    } else {
                        aiResponse.textContent = 'I\'m here to help with your learning. Could you please provide more details or ask about a specific topic?';
                    }
                    
                    messagesContainer.appendChild(aiResponse);
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                }, 1000);
            }
        }

        // Admin functions
        async function approveMaterial(materialId) {
            try {
                const result = await apiCall('materials.php', 'PUT', {
                    id: materialId,
                    status: 'approved'
                });
                
                if (result.success) {
                    populateAdminDashboard();
                    alert('Material approved successfully!');
                } else {
                    alert('Error: ' + result.message);
                }
            } catch (error) {
                alert('Error approving material. Please try again.');
                console.error('Approve material error:', error);
            }
        }

        async function rejectMaterial(materialId) {
            try {
                const result = await apiCall('materials.php', 'PUT', {
                    id: materialId,
                    status: 'rejected'
                });
                
                if (result.success) {
                    populateAdminDashboard();
                    alert('Material rejected!');
                } else {
                    alert('Error: ' + result.message);
                }
            } catch (error) {
                alert('Error rejecting material. Please try again.');
                console.error('Reject material error:', error);
            }
        }

        async function removeMaterial(materialId) {
            if (confirm('Are you sure you want to remove this material?')) {
                try {
                    const result = await apiCall('materials.php', 'DELETE', {
                        id: materialId
                    });
                    
                    if (result.success) {
                        populateAdminDashboard();
                        alert('Material removed successfully!');
                    } else {
                        alert('Error: ' + result.message);
                    }
                } catch (error) {
                    alert('Error removing material. Please try again.');
                    console.error('Remove material error:', error);
                }
            }
        }

        function editUser(userId) {
            alert('User editing would be implemented here.');
        }

        function suspendUser(userId) {
            if (confirm('Are you sure you want to suspend this user?')) {
                alert('User suspension would be implemented here.');
            }
        }

        // Initialize the app when the page loads
        window.onload = initApp;
    </script>
</body>
</html>